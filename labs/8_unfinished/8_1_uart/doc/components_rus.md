# Описания компонентов

## tb

Компонент является верхним уровнем моделирования, реализован на основе шаблона https://github.com/DigitalDesignSchool/ce2020labs/tree/master/next_step/dsmv/test_template

Включает в себя компонент lab_top - верхний уровень лабораторной работы.

К портам sw и key компонента lab_top подключен один и то же тестовый сигнал key. При моделировании сигнал key используется для управления выводом на семисегментный индикатор.
В зависимости от типа отладочной платы управление выводом на семисегментый индикатор будет выполняться либо через сигнал sw либо через key. 

Включает три процесса:
* pr_main - определяет параметры командной строки, ожидает завершения теста, выводит результат теста
* pr_timeout - реализует выход из теста по таймауту
* pr_test_case - формирует последовательность тестовых воздействий

Включает в себя файл tb_pkg.svh в котором реализованы следующие процедуры:

* test_finish - выводит результат выполнения теста
* test_init - формирует начальные значения сигналов
* test_seq_key0 - формирует последовательность нажатий на кнопку 0
* test_seq_key1 - формирует последовательность нажатий на кнопку 1
* tb_uart_send - передаёт байт через сигнал uart_rx
* tb_uart_receive - принимает байт через сигнал uart_tx
* test_seq_uart_p0 - передаёт через uart простую последовательность
* test_seq_uart_p1 - передаёт последовательность и проверяет результат приёма внутри lab_top
* test_seq_uart_p2 - принимает последовательность и сравнивает с ожидаемой

## lab_top

Компонент является верхним уровнем лабораторной работы. Он включается в компонент верхнего уровня для выбранной отладочной платы и в компонент верхнего уровня моделирования.

Включает в себя config.svh из каталог labs/common

Включает следующие компоненты:
* uart_receiver - приём данных через UART
* uart_transmitter - передача данных через UART
* hex_parser - декодирование данных
* seven_segment_display - вывод на семисегментный индикатор

Процесс pr_case_number выбирет источник данных для отображения на семисегментном индикаторе

Параметр SIMULATION определяет значения параметров update_hz и timeout_in_seconds в зависимости от режима. В режиме моделирования частота обновления семисегментного индикатора должна быть выше что бы процесс обновления был виден в течении сеанса моделирования.

## uart_receiver

Компонент предназначен для приёма одного байта через UART. Параметрами компонента является значение тактовой частоты и скорость передачи по UART. В зависимости от параметров опредеялется ширина сигналов counter, load_counter_value и начальное значение load_counter_value.

Основной алгоритм:
* определение фронта 1->0 для сигнала rx, отс
* пауза 3/2 периода - пропуск стартового бита и переход на середину бита 0
* цикл приёма восьми бит данных и одного стоп бита

Принятый байт выводится на сигнал byte_data и сопровождается сигналом byte_valid

Для искдючения метастабильности сигнал rx пропускается через два триггера - rx_sync1 и rx_sync

## uart_transmitter

Компонент предназначен для передачи одного байта через UART. Параметрами компонента является значение тактовой частоты и скорость передачи по UART. В зависимости от параметров опредеялется ширина сигналов counter, load_counter_value и начальное значение load_counter_value.

Сигнал byte_ready=1 означает готовность к передаче одного байта. Сигнал byte_valid=1 при условии byte_ready=1 начинает передачу байта данных.

## hex_parser

Компонент декодирует коды символов шестнадцатиричных цифр '0', '1' ... '9', 'A', 'B', 'C', 'D', 'E', 'F' и код возврата строки 0x0A. На выходе формируется сигналы out_address, out_data и out_valid которые могут быть использованы для записи данных в память.

Сигнал out_address увеличивается после приёма всех символов слова. Предполагается что последовательность символов передаётся без пауз. В случае если пауза превышает время заданное в параметре timeout_in_seconds то счётчик адреса сбрасывается в ноль и начинает ожидание следующей последовательности.

### Пример последовательности

Входная последовательность передаваемая через UART (вид в терминале)
```
    01234567
    89ABCDEF
```
Входная последовательность
|   in_char     |   Символ    |
|   :----:      |   :----:      |
|   0x30        |   0   |
|   0x31        |   1   |
|   0x32        |   2   |
|   0x33        |   3   |
|   0x34        |   4   |
|   0x35        |   5   |
|   0x36        |   6   |
|   0x37        |   7   |
|   0x0A        |   CR  |
|   0x38        |   8   |
|   0x39        |   9   |
|   0x40        |   A   |
|   0x41        |   B   |
|   0x42        |   C   |
|   0x43        |   D   |
|   0x44        |   E   |
|   0x45        |   F   |
|   0x0A        |   CR  |


Выходная последовательность:
|   out_address |   out_data    |
|   :----:       |   :----:      |
|   0x0000      |   0x01234567  |
|   0x0004      |   0x89ABCDEF  |



    


